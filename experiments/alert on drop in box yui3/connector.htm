<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Untitled Document</title>
		<style type="text/css">
			.topHandle,.botHandle{
				border:		1px solid black;
				width: 		5px;
				height:		5px;
				position:	fixed;
				z-index:	200;
			}
			.horiz {
				background:	#ff0000;
				height:		3px;
				position:	fixed;
				z-index:	100;
			}
			.topVert,.botVert{
				background:	#ff0000;
				width:		3px;
				position:	fixed;
				z-index:	100;
			}
			.connectable {
				border:		2px solid #2222FF;
				background-color:	#CCCCFF;
				width: 		300px;
				height: 	200px;
				position: 	absolute;
				top:		50px;
				left:		50px;
				z-index:	50;
			}
			.connPoint {
				border:		2px solid #22AA22;
				position: 	absolute;
				bottom:		-12px;
				left:		50%;
				width:		9px;
				height:		9px;
				/*z-index:	60;*/
			}
			
		</style>
		
		<!--<script type="text/javascript" src="http://yui.yahooapis.com/combo?3.0.0/build/yui/yui.js"></script>-->
		<script type="text/javascript" src="lib/yui/yui/yui-min.js"></script>
		<script type="text/javascript">
		function init() {
			YUI({
				filter:'min'
			}).use('dd-drag','dd-drop','dd-proxy','node','event', function (Y) {
				function handleMoved(handle) {
					// look up connector nodes
					var horiz 		= handle.connectorNodes['horiz'];
					var topVert 	= handle.connectorNodes['topVert'];
					var botVert 	= handle.connectorNodes['botVert'];
					var topHandle 	= handle.connectorNodes['topHandle'];
					var botHandle	= handle.connectorNodes['botHandle'];
					
					/* get and calculate */
					var topHandle_top	= topHandle.getY();
					var topHandle_left	= topHandle.getX();
					var botHandle_top	= botHandle.getY();
					var botHandle_left	= botHandle.getX();
					
					/* yes this is badly named. 
					 * basically, top handle is seen as above, left of bottom handle
					 * and positions need to be reversed if above assumptio is violated
					 */
					var topOffset 	= 0;
					var leftOffset 	= 0;
					if (topHandle_top > botHandle_top) 	{ topOffset = -1 }
					if (topHandle_left > botHandle_left) { leftOffset = -1 }

					/* TODO: this can prob be simplified with something like handleDelta 
					 * and only really need to calculate vert height once
					 */
					var topVert_height	= Math.abs(Math.floor((topHandle_top - botHandle_top)/2))+3;
					var topVert_top		= topHandle_top + 2 + (topOffset * (topVert_height - 3));
					var topVert_left	= topHandle_left + 2;

					var horiz_width		= Math.abs(Math.floor(topHandle_left - botHandle_left))+3;
					var horiz_top		= topVert_top -3 + topVert_height + (topOffset * (topVert_height-3));
					var horiz_left		= topVert_left + (leftOffset * (horiz_width-3));

					var botVert_height	= Math.abs(Math.floor((topHandle_top - botHandle_top)/2))+3;
					var botVert_top		= horiz_top + (topOffset * (botVert_height - 3));
					var botVert_left	= horiz_left -3 + horiz_width + (leftOffset * (horiz_width-3));

					/* set */
					topVert.setY(topVert_top);
					topVert.setX(topVert_left);
					topVert.setStyle('height',topVert_height + 'px');

					horiz.setY(horiz_top);
					horiz.setX(horiz_left);
					horiz.setStyle('width',horiz_width + 'px');
					
					botVert.setY(botVert_top);
					botVert.setX(botVert_left);
					botVert.setStyle('height',botVert_height + 'px');
				}
				
				/**
				 * 
				 * @param {int} thl left offset px of top handle
				 * @param {int} tht	top offset px of top handle
				 * @param {int} bhl left offset px of bot handle
				 * @param {int} bht top offset px of bot handle
				 */
				function newConnector(thl,tht,bhl,bht) {
					/* TODONE:giving nodes references to other parts of the connector would
					 * remove the need to look them up using classes for EACH MOVE
					 * TODONE: check if all this class rubbish is then still needed or if
					 * the node hash table can be always be used.
					 * 
					 * Not really needed but useful for knowing which connector parts belong to which
					 * so i'll keep it around for the moment.
					 * without being read they don't add huge overhead.
					 */ 
					var topHandleId 	= Y.guid('topHandle_');
					var botHandleId 	= Y.guid('botHandle_');
					/*
					 * Each section of a connector has the id of the handles as a class
					 * so all the parts can be related to their handles and thus to each other
					 */
					var topHandle 	= Y.Node.create('<div id="' 
													+ topHandleId
													+ '" class="'
													+ botHandleId
													+ ' topHandle"></div>');
					var botHandle = Y.Node.create('<div id="' 
													 + botHandleId
													 + '" class="'
													+ topHandleId
													+ ' botHandle"></div>');
					var topVert	 	= Y.Node.create('<div id="" class="'
													+ topHandleId + ' ' + botHandleId
													+ ' topVert"></div>');
					var botVert 		= Y.Node.create('<div id="" class="'
													+ topHandleId + ' ' + botHandleId
													+ ' botVert"></div>');
					var horiz 		= Y.Node.create('<div id="" class="'
													+ topHandleId + ' ' + botHandleId
													+ ' horiz"></div>');
													
					var body = Y.one('body');
					
					/*
					 * hash of all the nodes making up this connector
					 */
					var connectorNodes = {
						'topHandle':	topHandle,
						'horiz':		horiz,
						'topVert':		topVert,
						'botVert':		botVert,
						'botHandle':	botHandle
					}

					for (var i in connectorNodes) {
						// add reference to hash of node references to each node for this connector
						connectorNodes[i].connectorNodes = connectorNodes;
						// add each node to the body
						body.appendChild(connectorNodes[i]);
					}
					
					topHandle.setX(thl);
					topHandle.setY(tht);
					botHandle.setX(bhl);
					botHandle.setY(bht);
					
					// make handles dragable
					var ddTop 		= new Y.DD.Drag({node:topHandle});
					// make handle node accessible from the handle's DD
					ddTop.jd_node 	= topHandle;
					var ddbot 	= new Y.DD.Drag({node:botHandle});
					ddbot.jd_node = botHandle;
					
					// inserting counts as 'move' to get the lines into position
					handleMoved(topHandle);
				}
				
				//Listen for all drag:drag events
				Y.DD.DDM.on('drag:drag', function(e) {
					var node = e.target.jd_node;
					handleMoved(node);
				});
				
				newConnector(30,30,90,60);
				newConnector(300,300,390,360);
				
				// make connection point a drop target
				var connPoint = Y.one('#connPoint1');
				var dt = new Y.DD.Drop({
					node: connPoint
				});
				
				//Listen for all drag:drophit events
				Y.DD.DDM.on('drag:drophit', function(e) {
			 		var connPoint		= e.drop.get('node'),
						handle			= e.drag.get('node');
						
					/*
					 * If a topHandle has been dropped
					 * on a connPoint
					 */
					if (handle.hasClass('topHandle')) {
						connPoint.handle 	= handle;
						handle.connPoint 	= connPoint;
						alert('connected');
					}
			    });
				
				//Listen for all drag:dropmiss events
				Y.DD.DDM.on('drag:dropmiss', function(e) {
			 		var handle = e.target.jd_node;
					
					/*
					 * If a topHandle has been dropped 
					 * outside a connPoint
					 */
					if (handle.hasClass('topHandle')) {
						if (typeof(handle.connPoint) !== 'undefined') {
							var connPoint = handle.connPoint;
							if (typeof(connPoint.handle) !== 'undefined') {
								connPoint.handle = null;
							}
						}
						if (typeof(handle.connPoint) !== 'undefined') {
							handle.connPoint = null
						}
						alert('DISconnected');
					}
					
			    });
			});
		}

		</script>
	</head>
	<body onload="init()">
		<p>$HeadURL$</p>
		<p>$Id$</p>
		<div id="connectable" class="connectable">
			<div class="connPoint" id="connPoint1"></div>
		</div>
	</body>
</html>
